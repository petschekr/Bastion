<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/paper-item/paper-item.html" />
<link rel="import" href="../bower_components/paper-item/paper-item-body.html" />
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html" />
<link rel="stylesheet" href="../bower_components/sweetalert/dist/sweetalert.css" />
<script src="../bower_components/sweetalert/dist/sweetalert.min.js"></script>

<dom-module id="key-list">
	<style>
		paper-item-body {
			position: relative;
			padding-left: 16px;
			margin-left: -16px;
		}
		h1 {
			font-family: "Roboto";
			margin: 8px 16px 2px;
			font-size: 22px;
			border-bottom: 1px solid rgb(203, 203, 203);
			height: 32px;
		}
	</style>
	<template>
		<h1>Your keys</h1>
		<template is="dom-repeat" items="{{keys.owned}}">
			<paper-item>
				<paper-item-body two-line on-tap="itemClick">
					<div>{{item.info.0.username}}</div>
					<div secondary>{{item.info.0.email}}</div>
					<paper-ripple></paper-ripple>
				</paper-item-body>
				<paper-icon-button icon="create"></paper-icon-button>
			</paper-item>
		</template>
		<template is="dom-if" if="{{!keys.owned.length}}">
			<paper-item>
				<paper-item-body>
					<div><i>To generate or import a key, click the buttons at the upper right</i></div>
				</paper-item-body>
			</paper-item>
		</template>
		<h1>Contacts</h1>
		<template is="dom-repeat" items="{{keys.contacts}}">
			<paper-item>
				<paper-item-body two-line on-tap="itemClick">
					<div>{{item.info.0.username}}</div>
					<div secondary>{{item.info.0.email}}</div>
					<paper-ripple></paper-ripple>
				</paper-item-body>
				<paper-icon-button icon="send"></paper-icon-button>
			</paper-item>
		</template>
		<template is="dom-if" if="{{!keys.contacts.length}}">
			<paper-item>
				<paper-item-body>
					<div><i>You have no contacts yet</i></div>
				</paper-item-body>
			</paper-item>
		</template>
	</template>
	<script>
		var kbpgp = require("kbpgp");
		Polymer({
			is: "key-list",
			ready: function() {
				
			},
			mainInitialized: function() {
				// Load available keys
				this.keys = window.keys;
				function nameSort (a, b) {
					// Sort by name first
					if (a.info[0].username.toLowerCase() < b.info[0].username.toLowerCase()) return -1;
					if (a.info[0].username.toLowerCase() > b.info[0].username.toLowerCase()) return 1;
					// If equivalent, sort by email
					if (a.info[0].email.toLowerCase() < b.info[0].email.toLowerCase()) return -1;
					if (a.info[0].email.toLowerCase() > b.info[0].email.toLowerCase()) return 1;
					return 0;
				}
				this.keys.owned = this.keys.owned.sort(nameSort);
				this.keys.contacts = this.keys.contacts.sort(nameSort);
			},
			itemClick: function(e) {
				window.bastionWrapper.goToKeyDetail();
				var item = e.model.item;
				var keyToImport = (!!item.keys.private) ? item.keys.private : item.keys.public;
				kbpgp.KeyManager.import_from_armored_pgp({
					armored: keyToImport
				}, (function(err, importedKey) {
					if (err) {
						console.error(err);
						swal("Oops!", "An error occurred while opening that key", "error");
						return;
					}
					var info = {
						"key": {
							"type": undefined,
							"size": 0
						},
						"fingerprint": {
							"pretty": importedKey.get_fp2_formatted(),
							"array": importedKey.get_fp2_formatted().split(" "),
							"raw": importedKey.get_pgp_fingerprint_str()
						},
						"userids": importedKey.get_userids()
					};
					// RSA and ECC keys have different properties under their public key info
					try {
						info.key.size = importedKey.primary.key.pub.n.toHex().length * 4;
						info.key.type = "rsa";
					}
					catch (e) {
						info.key.size = importedKey.primary.key.pub.R.x.toHex().length * 4;
						info.key.type = "ecc";
					}
					// The formatted fingerprint has 2 spaces in the middle which confuses .split(" ")
					for (var i = 0; i < info.fingerprint.array.length; i++) {
						if (info.fingerprint.array[i] == "") {
							info.fingerprint.array.splice(i, 1);
						}
					}
					info.userids = info.userids.map(function (userid) {
						return userid.components;
					});
					this.selectedKeyInfo = info;
				}).bind(this));
			}
		});
	</script>
</dom-module>
